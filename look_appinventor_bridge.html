<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Look — App Inventor bridge</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:1rem;padding-bottom:2rem}
    #preview{max-width:100%;height:auto;border:1px solid #ddd;margin-top:0.5rem;display:none}
    #results{margin-top:1rem;padding:0.5rem;background:#f9f9f9;border-radius:4px;min-height:2rem}
    button,input{margin:0.5rem 0.25rem 0.5rem 0;padding:0.5rem 1rem;font-size:1rem}
    button{background:#0366d6;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:hover{background:#0256b8}
    #video{max-width:100%;border:1px solid #ddd;margin-top:0.5rem}
    #status{margin-top:0.5rem;font-style:italic;color:#666}
  </style>
</head>
<body>
  <h1>Look (App Inventor bridge)</h1>
  <p id="status">Model wordt geladen...</p>

  <div id="controls" style="display:none">
    <div>
      <input id="fileInput" type="file" accept="image/*" />
      <button id="btnClassify">Classificeer afbeelding</button>
    </div>
    <div>
      <button id="btnStartCamera">Open camera</button>
      <button id="btnStopCamera" style="display:none">Stop camera</button>
      <button id="btnCapture" style="display:none">Maak foto en classificeer</button>
    </div>
  </div>

  <img id="preview" alt="preview" />
  <video id="video" autoplay playsinline style="display:none"></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="results" aria-live="polite">Wachten op classificatie...</div>

  <!-- load scavenger_classes first, then tfjs, then look -->
  <script src="scavenger_classes.js"></script>
  <script src="tfjs-0.12.4.js"></script>
  <script src="look.js?v=2"></script>
  
  <script>
  // ========== App Inventor WebViewer Bridge ==========
  // This script bridges look.js predictions to App Inventor via WebViewString

  function sendToAppInventor(predictions) {
    var payload = {
      type: "predictions",
      timestamp: (new Date()).toISOString(),
      predictions: predictions
    };
    var s = JSON.stringify(payload);
    if (window.AppInventor && typeof AppInventor.setWebViewString === "function") {
      AppInventor.setWebViewString(s);
    } else {
      console.log("AppInventor bridge not available. Payload:", s);
    }
    showResults(predictions);
  }

  // This callback will be called by look.js when predictions are ready
  window.onPredictionsReady = function(preds) {
    try {
      sendToAppInventor(preds);
    } catch (e) {
      console.error("sendToAppInventor failed:", e);
    }
  };

  // Function for App Inventor to send commands to this page
  window.receiveFromApp = function(payloadStr) {
    try {
      var obj = JSON.parse(payloadStr);
    } catch (e) {
      console.error("Invalid JSON from app:", e);
      return;
    }
    if (!obj.cmd) return;
    switch (obj.cmd) {
      case "classify_base64":
        if (obj.image_base64) classifyBase64Image(obj.image_base64);
        break;
      case "start":
      case "startCamera":
        startCameraHandler();
        break;
      case "stopCamera":
        stopCameraHandler();
        break;
      case "capture":
        captureFrameAndClassify();
        break;
      default:
        console.warn("Unknown command from app:", obj.cmd);
    }
  };

  // ========== UI Logic ==========
  var fileInput = document.getElementById("fileInput");
  var preview = document.getElementById("preview");
  var canvas = document.getElementById("canvas");
  var video = document.getElementById("video");
  var resultsDiv = document.getElementById("results");
  var statusDiv = document.getElementById("status");
  var controlsDiv = document.getElementById("controls");
  var btnStartCamera = document.getElementById("btnStartCamera");
  var btnStopCamera = document.getElementById("btnStopCamera");
  var btnCapture = document.getElementById("btnCapture");

  var streamRef = null;

  // Wait for look.js model to be ready
  var checkReadyInterval = setInterval(function() {
    if (window.mobilenet || (window.classifyImageElement && window.classifyDataUrl)) {
      clearInterval(checkReadyInterval);
      statusDiv.textContent = "Model klaar! Kies een actie hieronder.";
      controlsDiv.style.display = "block";
      console.log("Look.js model is ready and bridge is active.");
    }
  }, 100);

  // Stop checking after 30 seconds
  setTimeout(function() {
    clearInterval(checkReadyInterval);
    if (controlsDiv.style.display === "none") {
      statusDiv.textContent = "Model laden mislukt. Controleer console.";
      statusDiv.style.color = "red";
    }
  }, 30000);

  fileInput.addEventListener("change", function () {
    var f = fileInput.files[0];
    if (!f) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = "block";
      preview.onload = function() {
        // Don't auto-classify; wait for button click
      };
    };
    reader.readAsDataURL(f);
  });

  document.getElementById("btnClassify").addEventListener("click", function(){
    if (preview.src && preview.style.display !== "none") {
      resultsDiv.textContent = "Classificeren...";
      classifyDOMImage(preview);
    } else if (fileInput.files.length) {
      var evt = new Event('change'); 
      fileInput.dispatchEvent(evt);
      setTimeout(function() {
        if (preview.src) classifyDOMImage(preview);
      }, 100);
    } else {
      alert("Kies eerst een afbeelding.");
    }
  });

  btnStartCamera.addEventListener("click", startCameraHandler);
  btnStopCamera.addEventListener("click", stopCameraHandler);
  document.getElementById("btnCapture").addEventListener("click", captureFrameAndClassify);

  function showResults(predictions) {
    resultsDiv.innerHTML = "";
    if (!predictions || predictions.length === 0) {
      resultsDiv.textContent = "Geen resultaten";
      return;
    }
    var ul = document.createElement("ul");
    ul.style.margin = "0";
    ul.style.paddingLeft = "1.5rem";
    predictions.slice(0, 5).forEach(function(p) {
      var li = document.createElement("li");
      li.textContent = p.label + " — " + (Math.round(p.confidence * 10000)/100) + "%";
      ul.appendChild(li);
    });
    resultsDiv.appendChild(ul);
  }

  function classifyBase64Image(dataUrl) {
    var img = new Image();
    img.onload = function() {
      preview.src = dataUrl;
      preview.style.display = "block";
      classifyDOMImage(img);
    };
    img.onerror = function(e){ console.error("Invalid base64 image", e); };
    img.src = dataUrl;
  }

  function classifyDOMImage(imgElement) {
    // Call the wrapper exposed by look.js
    if (typeof window.classifyImageElement === "function") {
      window.classifyImageElement(imgElement);
    } else {
      console.error("window.classifyImageElement not found. Check look.js.");
      resultsDiv.textContent = "Fout: classify functie niet gevonden.";
    }
  }

  function startCameraHandler() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Camera niet ondersteund in deze browser/WebView.");
      return;
    }
    navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false})
      .then(function(s){
        streamRef = s;
        video.srcObject = s;
        video.style.display = "block";
        preview.style.display = "none";
        btnStartCamera.style.display = "none";
        btnStopCamera.style.display = "inline-block";
        btnCapture.style.display = "inline-block";
        statusDiv.textContent = "Camera actief. Klik 'Maak foto en classificeer' om te analyseren.";
      })
      .catch(function(err){
        console.error("Camera error:", err);
        alert("Kon camera niet openen: " + err.message);
      });
  }

  function stopCameraHandler() {
    if (streamRef) {
      streamRef.getTracks().forEach(function(t){ t.stop(); });
      streamRef = null;
      video.style.display = "none";
      btnStartCamera.style.display = "inline-block";
      btnStopCamera.style.display = "none";
      btnCapture.style.display = "none";
      statusDiv.textContent = "Camera gestopt.";
    }
  }

  function captureFrameAndClassify() {
    if (!video || video.readyState < 2) {
      alert("Video nog niet klaar.");
      return;
    }
    var w = video.videoWidth, h = video.videoHeight;
    canvas.width = 224; 
    canvas.height = 224;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    preview.src = canvas.toDataURL("image/jpeg");
    preview.style.display = "block";
    resultsDiv.textContent = "Classificeren...";
    classifyDOMImage(preview);
  }

  // Test helper
  window.sendTest = function(){
    sendToAppInventor([{label:"test", confidence:0.99}]);
  };

  </script>
</body>
</html>